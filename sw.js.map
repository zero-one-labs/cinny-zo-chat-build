{"version":3,"file":"sw.mjs","sources":["../src/sw.ts"],"sourcesContent":["/// <reference lib=\"WebWorker\" />\n\nexport type {};\ndeclare const self: ServiceWorkerGlobalScope;\n\nasync function askForAccessToken(client: Client): Promise<string | undefined> {\n  return new Promise((resolve) => {\n    const responseKey = Math.random().toString(36);\n    const listener = (event: ExtendableMessageEvent) => {\n      if (event.data.responseKey !== responseKey) return;\n      resolve(event.data.token);\n      self.removeEventListener('message', listener);\n    };\n    self.addEventListener('message', listener);\n    client.postMessage({ responseKey, type: 'token' });\n  });\n}\n\nfunction fetchConfig(token?: string): RequestInit | undefined {\n  if (!token) return undefined;\n\n  return {\n    headers: {\n      Authorization: `Bearer ${token}`,\n    },\n    cache: 'default',\n  };\n}\n\nself.addEventListener('activate', (event: ExtendableEvent) => {\n  event.waitUntil(clients.claim());\n});\n\nself.addEventListener('fetch', (event: FetchEvent) => {\n  const { url, method } = event.request;\n  if (method !== 'GET') return;\n  if (\n    !url.includes('/_matrix/client/v1/media/download') &&\n    !url.includes('/_matrix/client/v1/media/thumbnail')\n  ) {\n    return;\n  }\n  event.respondWith(\n    (async (): Promise<Response> => {\n      const client = await self.clients.get(event.clientId);\n      let token: string | undefined;\n      if (client) token = await askForAccessToken(client);\n\n      return fetch(url, fetchConfig(token));\n    })()\n  );\n});\n"],"names":[],"mappings":"AAKA,eAAe,kBAAkB,QAA6C;AAC5E,SAAO,IAAI,QAAQ,CAAC,YAAY;AAC9B,UAAM,cAAc,KAAK,OAAA,EAAS,SAAS,EAAE;AAC7C,UAAM,WAAW,CAAC,UAAkC;AAClD,UAAI,MAAM,KAAK,gBAAgB,YAAa;AAC5C,cAAQ,MAAM,KAAK,KAAK;AACxB,WAAK,oBAAoB,WAAW,QAAQ;AAAA,IAC9C;AACA,SAAK,iBAAiB,WAAW,QAAQ;AACzC,WAAO,YAAY,EAAE,aAAa,MAAM,SAAS;AAAA,EACnD,CAAC;AACH;AAEA,SAAS,YAAY,OAAyC;AAC5D,MAAI,CAAC,MAAO,QAAO;AAEnB,SAAO;AAAA,IACL,SAAS;AAAA,MACP,eAAe,UAAU,KAAK;AAAA,IAAA;AAAA,IAEhC,OAAO;AAAA,EAAA;AAEX;AAEA,KAAK,iBAAiB,YAAY,CAAC,UAA2B;AAC5D,QAAM,UAAU,QAAQ,OAAO;AACjC,CAAC;AAED,KAAK,iBAAiB,SAAS,CAAC,UAAsB;AACpD,QAAM,EAAE,KAAK,OAAA,IAAW,MAAM;AAC9B,MAAI,WAAW,MAAO;AACtB,MACE,CAAC,IAAI,SAAS,mCAAmC,KACjD,CAAC,IAAI,SAAS,oCAAoC,GAClD;AACA;AAAA,EACF;AACA,QAAM;AAAA,KACH,YAA+B;AAC9B,YAAM,SAAS,MAAM,KAAK,QAAQ,IAAI,MAAM,QAAQ;AACpD,UAAI;AACJ,UAAI,OAAQ,SAAQ,MAAM,kBAAkB,MAAM;AAElD,aAAO,MAAM,KAAK,YAAY,KAAK,CAAC;AAAA,IACtC,GAAA;AAAA,EAAG;AAEP,CAAC;"}